<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reports — ISV Change Control Portal</title>
    <link rel="stylesheet" href="modern.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.30.0/tabler-icons.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            background: var(--card);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.03);
            margin-bottom: 16px;
        }
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--muted);
        }
        #requestsChart {
            max-width: 300px;
            max-height: 300px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">FCC • ISV Change Portal</div>
            <nav>
                <a class="nav-link" href="user_dashboard.html">Dashboard</a>
                <a class="nav-link active" href="#" data-action="reports">Reports</a>
            </nav>
            <div class="sidebar-footer">Reports • <span style="color:var(--muted)">Analytics view</span></div>
        </aside>

        <main class="main-content">
            <header class="bar">
                <div class="bar-left">
                    <h1>Reports</h1>
                    <p class="muted">Comprehensive analytics and insights for change control requests.</p>
                </div>
                <div class="bar-right">
                    <input id="search" placeholder="Search reports..." />
                    <button id="refresh">Refresh</button>
                    <button id="exportCsv">Export CSV</button>
                    <button id="generateReport">Generate Report</button>
                </div>
            </header>

            <section class="summary-cards">
                <div class="summary-card">
                    <h3>Total Requests</h3>
                    <div class="value" id="totalRequests">0</div>
                </div>
                <div class="summary-card">
                    <h3>Pending</h3>
                    <div class="value" id="pendingRequests">0</div>
                </div>
                <div class="summary-card">
                    <h3>Approved</h3>
                    <div class="value" id="approvedRequests">0</div>
                </div>
                <div class="summary-card">
                    <h3>Rejected</h3>
                    <div class="value" id="rejectedRequests">0</div>
                </div>
            </section>

            <section class="chart-container">
                <h3>Requests Over Time</h3>
                <canvas id="requestsChart"></canvas>
            </section>

            <section id="reportsList" class="cards-grid"></section>

            <footer class="foot">Reports are generated from live data. Use the export button to download detailed CSV reports.</footer>
        </main>
    </div>

    <div id="modal" class="modal hidden">
        <div class="modal-panel">
            <button class="close" id="closeModal">×</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="app.js"></script>
    <script>
        // Load reports data and render
        async function loadReports() {
            try {
                const res = await fetch('/api/requests');
                const data = await res.json();
                updateSummary(data);
                renderChart(data);
                renderReportsList(data);
            } catch (e) {
                console.error('Error loading reports:', e);
            }
        }

        function updateSummary(data) {
            document.getElementById('totalRequests').textContent = data.length;
            document.getElementById('pendingRequests').textContent = data.filter(r => r.status === 'Pending').length;
            document.getElementById('approvedRequests').textContent = data.filter(r => r.status === 'Approved').length;
            document.getElementById('rejectedRequests').textContent = data.filter(r => r.status === 'Rejected').length;
        }

        function renderChart(data) {
            const ctx = document.getElementById('requestsChart').getContext('2d');
            const statusCounts = data.reduce((acc, r) => {
                acc[r.status] = (acc[r.status] || 0) + 1;
                return acc;
            }, {});
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#06b6d4', '#10b981', '#ef4444', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function renderReportsList(data) {
            const container = document.getElementById('reportsList');
            container.innerHTML = '';
            data.forEach(request => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h4>${request.changeType || 'Request'}: ${request.title}</h4>
                    <div class="meta">${request.submittedBy} • ${new Date(request.submittedAt).toLocaleDateString()}</div>
                    <div class="badge ${request.status.toLowerCase()}">${request.status}</div>
                    <div class="summary">${request.description}</div>
                    <div class="actions">
                        <button class="btn ghost" data-action="view" data-id="${request.id}">View Details</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        document.getElementById('refresh').addEventListener('click', loadReports);
        document.getElementById('exportCsv').addEventListener('click', () => {
            window.open('/api/export', '_blank');
        });
        document.getElementById('generateReport').addEventListener('click', () => {
            alert('Report generation feature coming soon!');
        });

        // Initial load
        loadReports();
    </script>
</body>
</html>
